## 北京科技大学第十九届智能车竞赛校内赛图传上位机

上位机基于Node.js开发，通过Websocket进行通信，支持极速光电龙芯/完全模型组别

<img width="432" height="253" alt="26a5eeef0a33d42b31f10c653de3abe3" src="https://github.com/user-attachments/assets/c8c4467b-3972-41e6-bd5b-d065181f2bee" />

### 特点

- 迁移简单，项目提供了下位机例程，仅需安装Boost和OpenCV即可。
- 支持双向传输，下位机可传图给上位机，上位机可发送发车/停车等命令给下位机程序
- 低CPU占用，基于UDP和TCP之间
- 支持传输调试数据，使用包装好的函数，简单方便
- 支持即时调试（需单独构建调试程序，难度不大）
- 跨平台支持（推荐在Linux下使用，但Windows也可支持）

### 使用方法

- 上位机
1. 克隆项目（下文使用的是Ubuntu虚拟机，我克隆到的是在用户主目录下，也就是```/home/username/```，写程序的时候考虑到校内赛比赛选手对绝对相对路径不熟悉，所以都用的是绝对路径）
2. 安装Node.js
3. 输入```npm install pnpm -g```安装pnpm
4. 输入```pnpm i```安装依赖
5. 修改run.js的```exePath```为自己调试程序的路径（如果不需要调试功能则不用做）
6. 输入```node run```运行程序

- 下位机
    - 安装Boost库，在CMakeLists.txt中配置boost目录，如```include_directories(/home/username/boost_1_77_0)```
    - 迁移cpp_program_websocket_example到自己的工程中，配置电脑ip upper_ip（注意是自己电脑的，不是虚拟机的）
    - 如果需要使用调试功能，按照debugger_example的样例构建一个新的程序，并配置好相关读取和输出路径（与run.js输出和读取图片的路径一致），这个调试程序放在自己电脑上，不需要传到板卡上。
    
- 使用方法/原理
    - 图传上位机是服务器，板卡程序和电脑web网页都是客户端，客户端与服务器之间会进行图片传输。服务器需要启动（node run）后客户端才能连接，web网页连接上了服务器 WS连接状态 会变绿，板卡连接了服务器 心跳状态 会变绿。
    - 图像调试：自动执行/home/smartcar/上位机_调试部分/build/project，并处理起始图片索引.jpg到终止图片索引.jpg，如果起始图片索引>终止图片索引，则跳转到起始图片索引.jpg，而不会做任何处理。上位机调试读取的目录默认在/home/smartcar/output。这几个目录都需要自己修改
    - 按↑↓键可以选择上一张/下一张图进行调试
    - 发车/停车控制：帧数必须大于0小于60，且能被60整除。
    - 查询原图：启用后，按↑↓的时候看到的是原图而不是处理后的。
    - 详细调试信息：显示通过header.push()传输的调试信息。

### 常见问题
1. 虚拟机中如何使用？
    - VMWare设置NAT模式，在虚拟机中输入ip a找到虚拟机IP，在VMWare的虚拟网络编辑器中映射3000 3001端口，IP填虚拟机IP
2. 下位机无法连上上位机
    - 连接板卡终端，输入ping 自己电脑IP，不能ping通见常见问题请关闭windows防火墙，能ping通见常见问题1
    - 电脑和板卡需在同一个WIFI
    - 上位机程序没开启，在虚拟机终端里看一下有没有在运行的
    - 实在不行，可以在虚拟机中打开web.html，一样的效果
    - 如果以前能板卡能传图给上位机，第二天突然就连不上了，提示心跳断开，大概率是自己电脑ip变了，重新改自己的ip
3. 无法使用图像调试功能
    - 需要自己编译一个调试程序，图像处理代码与板卡上运行的代码一致。调试程序能够读取image文件夹下的图片，然后输出到另一个指定目录才行。边界点、中心点可以用opencv自带的点绘制显示。
    - 程序执行路径填错了，看命令执行返回结果
